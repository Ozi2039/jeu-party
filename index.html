<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Jackson le goat</title>
<style>
  html, body {
    margin:0;
    padding:0;
    height:100%;
    width:100%;
    font-family:sans-serif;
    background:#0d1117;
    color:white;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    -webkit-user-select: none;
    user-select: none;
  }

  .phone {
    width: 320px;
    height: 600px;
    border-radius: 36px;
    background: url('Zu1MKPS9.jpg') no-repeat center/cover;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 20px;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .phone::before {
    content: "";
    position: absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.5);
    z-index: 0;
    border-radius: 36px;
  }

  .phone > * { position: relative; z-index: 1; }

  .fullscreen {
    width: 100vw !important;
    height: calc(var(--vh, 1vh) * 100) !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  .screen {display:none; width:100%; flex-direction:column; align-items:center; justify-content:center;}
  .active {display:flex;}

  button {
    padding:10px 15px; 
    margin:5px; 
    border:none; 
    border-radius:8px; 
    cursor:pointer; 
    background:#00d4ff; 
    font-weight:bold; 
    font-size:14px;
    color:#000;
    flex: 1;
  }

  .button-row {
    display: flex;
    justify-content: center;
    width: 100%;
    max-width: 280px;
  }

  input, textarea {
    padding:8px; 
    margin:5px; 
    border-radius:6px; 
    border:none; 
    width:100%;
    background: rgba(255,255,255,0.8);
    color: #000;
  }

  .players-list {
    margin:3px 0;
    max-height: 100px;
    overflow-y: auto;
    width: 100%;
    max-width: 280px;
  }

  .call-box {text-align:center; width: 100%;}
  .caller {font-size:20px; margin-bottom:20px;}
  .slide-container {
    position: relative;
    width: calc(100% - 20px);
    height: 60px;
    background: rgba(0,0,0,0.6);
    border-radius: 30px;
    overflow: hidden;
    margin: 0 10px;
  }
  .slide-btn {
    position: absolute;
    top:5px;
    left:5px;
    width:50px;
    height:50px;
    background:#00ff88;
    border-radius:50%;
    cursor:grab;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    user-select: none;
    touch-action: none;
  }
  .question {
    font-size:20px;
    max-width:280px;
    padding:20px;
    background: rgba(0,0,0,0.7);
    border-radius:12px;
    margin:20px;
    text-align:center;
  }
  .question-prompt {
    font-size:16px;
    color:#ccc;
    margin-bottom:10px;
    text-align:center;
  }

  .slide-text {text-align:center; margin-top:10px; font-size:14px; color:#ccc;}
  .ask-jackson-screen {text-align:center; width:100%; max-width:280px;}
  .ask-jackson-screen textarea {min-height:100px; resize:vertical;}
  
  @media (max-width: 480px) {
    .phone { 
      width: 100vw; 
      height: calc(var(--vh, 1vh) * 100); 
      border-radius:0; 
      box-shadow: none;
    }
    .phone::before { border-radius:0; }
    .question { max-width: calc(100% - 40px); }
    .slide-container {
      width: calc(100% - 20px);
      margin: 0 10px;
    }
  }
</style>
</head>
<body>

<div class="phone" id="phone">
  <div id="menu" class="screen active">
    <h1>🐐 Jackson le goat 🐐</h1>
    <button onclick="toggleFullScreen()">📱 Plein écran</button>
    <h3>Liste des joueurs</h3>
    <div id="playersList" class="players-list"></div>
    <input type="text" id="playerInput" placeholder="Nom du joueur">
    <button onclick="addPlayer()">Ajouter joueur</button>
    
    <h3>Importer Questions (JSON)</h3>
    <input type="file" id="questionsFile" accept=".json">
    <textarea id="questionsInput" rows="5" cols="30" readonly></textarea><br>
    
    <br><br>
    <div class="button-row">
      <button id="playBtn">🎮 Jouer</button>
      <button onclick="confirmEndGame()">🏁 Terminer</button>
    </div>
  </div>

  <div id="callScreen" class="screen">
    <div class="call-box">
      <div class="caller" id="callerName"></div>
      <div class="slide-container" id="slider">
        <div class="slide-btn" id="slideBtn">📞</div>
      </div>
      <div class="slide-text">→ Glisse pour décrocher</div>
    </div>
  </div>

  <div id="questionScreen" class="screen">
    <div class="question-prompt" id="questionPrompt"></div>
    <div class="question" id="questionText"></div>
    <div class="button-row">
      <button onclick="answerQuestion()">✅ Répondre</button>
      <button onclick="takeShot()">🥃 Shot</button>
    </div>
    <div class="button-row">
      <button onclick="backToMenu()">🏠 Menu</button>
      <button onclick="confirmEndGame()">🏁 Terminer</button>
    </div>
  </div>

  <div id="askJacksonScreen" class="screen">
    <div class="ask-jackson-screen">
      <h2>Pose une question à Jackson</h2>
      <textarea id="newQuestionInput" placeholder="Ta question pour Jackson..."></textarea>
      <div class="button-row">
        <button onclick="submitNewQuestion()">📤 Envoyer</button>
        <button onclick="skipNewQuestion()">➡️ Passer</button>
      </div>
    </div>
  </div>

  <div id="statsScreen" class="screen">
    <h2>📊 Stats de la partie</h2>
    <div id="statsList"></div>
    <div class="button-row">
      <button onclick="endGameToMenu()">🏠 Retour au Menu</button>
      <button onclick="downloadQuestions()">⬇️ Télécharger Questions</button>
    </div>
  </div>
</div>

<script>
let players = [];
let questions = [];
let usedQuestions = [];
let stats = {};
let currentPlayer = "";
let lastPlayer = "";
let lastQuestion = "";
document.getElementById("questionsInput").value = JSON.stringify(questions, null, 2);

function addPlayer(){
  const name = document.getElementById("playerInput").value.trim();
  if(name){ 
    players.push(name); 
    stats[name] = {received: 0, answered: 0, shotsTaken: 0};
    document.getElementById("playerInput").value = ""; 
    renderPlayers(); 
  }
}
function renderPlayers(){
  const list = document.getElementById("playersList");
  list.innerHTML = players.map((p,i)=>`<div>${p} <button onclick="removePlayer(${i})">❌</button></div>`).join("");
}
function removePlayer(i){ 
  delete stats[players[i]];
  if (players[i] === lastPlayer) lastPlayer = "";
  players.splice(i,1); 
  renderPlayers(); 
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (file && file.type === "application/json") {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        questions = JSON.parse(e.target.result);
        usedQuestions = [];
        lastQuestion = "";
        document.getElementById("questionsInput").value = JSON.stringify(questions, null, 2);
        alert("Questions chargées avec succès !");
      } catch (e) {
        alert("Erreur : Fichier JSON invalide !");
      }
    };
    reader.readAsText(file);
  } else {
    alert("Veuillez sélectionner un fichier JSON valide !");
  }
}

document.getElementById("questionsFile").addEventListener("change", handleFileUpload);

const menu = document.getElementById("menu");
const callScreen = document.getElementById("callScreen");
const questionScreen = document.getElementById("questionScreen");
const askJacksonScreen = document.getElementById("askJacksonScreen");
const statsScreen = document.getElementById("statsScreen");
const callerName = document.getElementById("callerName");
const questionText = document.getElementById("questionText");
const questionPrompt = document.getElementById("questionPrompt");
const phone = document.getElementById("phone");

document.getElementById("playBtn").addEventListener("click", startGame);

function toggleFullScreen() {
  if (!document.fullscreenElement) {
    const docEl = document.documentElement;
    if (docEl.requestFullscreen) {
      docEl.requestFullscreen().catch(err => console.error('Fullscreen error:', err));
    } else if (docEl.webkitRequestFullscreen) {
      docEl.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT).catch(err => console.error('Fullscreen error:', err));
    }
    phone.classList.add('fullscreen');
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen().catch(err => console.error('Exit fullscreen error:', err));
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
    phone.classList.remove('fullscreen');
  }
}

function startGame(){
  if(players.length===0){ alert("Ajoute au moins un joueur !"); return; }
  if(questions.length===0){ alert("Veuillez importer un fichier de questions JSON !"); return; }

  players.forEach(p => stats[p] = stats[p] || {received: 0, answered: 0, shotsTaken: 0});

  let availablePlayers = players.filter(p => p !== lastPlayer);
  if (availablePlayers.length === 0) availablePlayers = players;
  const player = availablePlayers[Math.floor(Math.random() * availablePlayers.length)];

  let availableQuestions = questions.filter(q => !usedQuestions.includes(q) && q !== lastQuestion);
  if (availableQuestions.length === 0) {
    availableQuestions = questions.filter(q => q !== lastQuestion);
    usedQuestions = [];
  }
  if (availableQuestions.length === 0) availableQuestions = questions;
  const question = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];

  if (!usedQuestions.includes(question)) usedQuestions.push(question);
  currentPlayer = player;
  lastPlayer = player;
  lastQuestion = question;
  stats[player].received++;

  callerName.textContent = `📞 Yo ${player}, Jackson t'appelle !`;
  questionPrompt.textContent = "Répond à la question ou prend un shot :";
  questionText.textContent = question;

  menu.classList.remove("active");
  callScreen.classList.add("active");

  document.querySelectorAll('#menu input, #menu textarea, #menu button').forEach(el => el.style.display='none');
  document.querySelectorAll('#menu .button-row').forEach(el => el.style.display='flex');

  initSlider();
}

function answerQuestion(){
  stats[currentPlayer].answered++;
  showAskJacksonScreen();
}

function takeShot(){
  stats[currentPlayer].shotsTaken++;
  showAskJacksonScreen();
}

function showAskJacksonScreen(){
  questionScreen.classList.remove("active");
  askJacksonScreen.classList.add("active");
  document.getElementById("newQuestionInput").value = "";
}

function submitNewQuestion(){
  const newQuestion = document.getElementById("newQuestionInput").value.trim();
  if(newQuestion){
    questions.push(newQuestion);
    document.getElementById("questionsInput").value = JSON.stringify(questions, null, 2);
  }
  continueGame();
}

function skipNewQuestion(){
  continueGame();
}

function continueGame(){ 
  callScreen.classList.remove("active"); 
  questionScreen.classList.remove("active"); 
  askJacksonScreen.classList.remove("active");
  startGame(); 
}

function backToMenu(){ 
  questionScreen.classList.remove("active"); 
  callScreen.classList.remove("active"); 
  askJacksonScreen.classList.remove("active");
  menu.classList.add("active");
  document.querySelectorAll('#menu input, #menu textarea, #menu button').forEach(el => el.style.display='block');
  document.querySelectorAll('#menu .button-row').forEach(el => el.style.display='flex');
}

function confirmEndGame(){
  if (confirm("Voulez-vous vraiment terminer la partie ?")) {
    if (questionScreen.classList.contains("active") && currentPlayer && stats[currentPlayer].received > 0) {
      stats[currentPlayer].received--;
    }
    questionScreen.classList.remove("active");
    callScreen.classList.remove("active");
    askJacksonScreen.classList.remove("active");
    statsScreen.classList.add("active");
    renderStats();
  }
}

function endGameToMenu(){
  statsScreen.classList.remove("active");
  menu.classList.add("active");
  document.querySelectorAll('#menu input, #menu textarea, #menu button').forEach(el => el.style.display='block');
  document.querySelectorAll('#menu .button-row').forEach(el => el.style.display='flex');
}

function renderStats(){
  const list = document.getElementById("statsList");
  list.innerHTML = players.map(p => {
    const s = stats[p];
    const ratio = s.received > 0 ? Math.round((s.answered / s.received) * 100) : 0;
    return `<div>👤 ${p}: ✅ Réponses: ${s.answered}, 🥃 Shots: ${s.shotsTaken}, 📈 Ratio: ${ratio}%</div>`;
  }).join("");
}

function downloadQuestions(){
  const data = JSON.stringify(questions, null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'questions.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function initSlider(){
  const btn = document.getElementById("slideBtn");
  const slider = document.getElementById("slider");
  let isDragging=false, startX=0;
  btn.style.left="5px";

  const maxSlideDistance = slider.offsetWidth - btn.offsetWidth - 10;

  btn.onmousedown=e=>{ isDragging=true; startX=e.clientX; };
  document.onmouseup=e=>{ 
    if(isDragging){ 
      isDragging=false; 
      if(parseInt(btn.style.left) > maxSlideDistance * 0.9){ 
        callScreen.classList.remove("active"); 
        questionScreen.classList.add("active"); 
      } else {
        btn.style.left="5px"; 
      }
    } 
  };
  document.onmousemove=e=>{ 
    if(isDragging){ 
      let dx=e.clientX-startX; 
      btn.style.left=Math.min(Math.max(5,5+dx),maxSlideDistance)+"px"; 
    } 
  };

  btn.ontouchstart=e=>{ 
    isDragging=true; 
    startX=e.touches[0].clientX; 
    e.preventDefault();
  };
  btn.ontouchend=e=>{ 
    if(isDragging){ 
      isDragging=false; 
      if(parseInt(btn.style.left) > maxSlideDistance * 0.9){ 
        callScreen.classList.remove("active"); 
        questionScreen.classList.add("active"); 
      } else {
        btn.style.left="5px"; 
      }
    } 
  };
  btn.ontouchmove=e=>{ 
    if(isDragging){ 
      let dx=e.touches[0].clientX-startX; 
      btn.style.left=Math.min(Math.max(5,5+dx),maxSlideDistance)+"px"; 
      e.preventDefault(); 
    } 
  };
}

function setVh() {
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setVh);
window.addEventListener('load', setVh);

function isAppleDevice() {
  return /iPhone|iPad|iPod|Macintosh/.test(navigator.userAgent);
}
window.addEventListener("load", () => {
  if (isAppleDevice()) {
    alert("⚠️ Sur iPhone/iPad, le mode plein écran doit être activé manuellement.");
  }
});
</script>
</body>
</html>
